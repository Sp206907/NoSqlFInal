<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PennyWise - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            PennyWise
        </a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="accounts.html" class="nav-link">–°—á–µ—Ç–∞</a></li>
            <li><a href="transactions.html" class="nav-link active">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a></li>
            <li><a href="statistics.html" class="nav-link">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            <li><span id="userName" style="color: var(--dark-color); font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span></li>
            <li><a href="#" id="logoutBtn" class="nav-link">–í—ã—Ö–æ–¥</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="d-flex justify-between align-center mb-3">
            <h1 style="color: white;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h1>
            <button class="btn btn-success" onclick="openAddTransactionModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex gap-2" style="flex-wrap: wrap;">
                    <select id="filterType" class="form-select" style="width: auto;">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="income">–î–æ—Ö–æ–¥—ã</option>
                        <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
                    </select>
                    <select id="filterAccount" class="form-select" style="width: auto;">
                        <option value="">–í—Å–µ —Å—á–µ—Ç–∞</option>
                    </select>
                    <input type="date" id="filterStartDate" class="form-control" style="width: auto;">
                    <input type="date" id="filterEndDate" class="form-control" style="width: auto;">
                    <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–°—á–µ—Ç</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
                <button class="close" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <label for="transactionType">–¢–∏–ø</label>
                    <select id="transactionType" class="form-select" required>
                        <option value="income">–î–æ—Ö–æ–¥</option>
                        <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionAccount">–°—á–µ—Ç</label>
                    <select id="transactionAccount" class="form-select" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionAmount">–°—É–º–º–∞</label>
                    <input type="number" id="transactionAmount" class="form-control" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="transactionCategory" class="form-select" required>
                        <option value="food">–ï–¥–∞</option>
                        <option value="transport">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                        <option value="entertainment">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                        <option value="shopping">–ü–æ–∫—É–ø–∫–∏</option>
                        <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                        <option value="education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="bills">–°—á–µ—Ç–∞</option>
                        <option value="utilities">–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</option>
                        <option value="rent">–ê—Ä–µ–Ω–¥–∞</option>
                        <option value="insurance">–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ</option>
                        <option value="taxes">–ù–∞–ª–æ–≥–∏</option>
                        <option value="gifts">–ü–æ–¥–∞—Ä–∫–∏</option>
                        <option value="subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</option>
                        <option value="sports">–°–ø–æ—Ä—Ç</option>
                        <option value="travel">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                        <option value="cafe">–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
                        <option value="salary">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                        <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                        <option value="investment">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                        <option value="freelance">–§—Ä–∏–ª–∞–Ω—Å</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="transactionDescription" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" required>
                </div>
                <div class="form-group">
                    <label for="transactionDate">–î–∞—Ç–∞</label>
                    <input type="date" id="transactionDate" class="form-control" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let transactions = [];
        let accounts = [];

        // Load initial data
        async function loadData() {
            try {
                // Load accounts
                const accountsResult = await api.getAccounts();
                if (accountsResult.success) {
                    accounts = accountsResult.data;
                    populateAccountSelects();
                }

                // Load transactions
                await loadTransactions();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        async function loadTransactions(filters = {}) {
            try {
                const result = await api.getTransactions(filters);
                if (result.success) {
                    transactions = result.data;
                    displayTransactions();
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
            }
        }

        function populateAccountSelects() {
            const selects = [
                document.getElementById('transactionAccount'),
                document.getElementById('filterAccount')
            ];

            selects.forEach((select, index) => {
                const currentValue = select.value;
                const options = accounts.map(acc => 
                    `<option value="${acc._id}">${acc.name}</option>`
                ).join('');
                
                if (index === 0) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>' + options;
                } else {
                    select.innerHTML = '<option value="">–í—Å–µ —Å—á–µ—Ç–∞</option>' + options;
                }
                
                select.value = currentValue;
            });
        }

        function displayTransactions() {
            const tbody = document.querySelector('#transactionsTable tbody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description}</td>
                    <td>${getCategoryLabel(transaction.category)}</td>
                    <td>${transaction.accountId?.name || 'N/A'}</td>
                    <td style="font-weight: 600; color: ${transaction.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)'}">
                        ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                    </td>
                    <td>
                        <span class="badge badge-${transaction.type === 'income' ? 'success' : 'danger'}">
                            ${transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editTransaction('${transaction._id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${transaction._id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function getCategoryLabel(category) {
            const labels = {
                'food': '–ï–¥–∞',
                'transport': '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
                'entertainment': '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
                'shopping': '–ü–æ–∫—É–ø–∫–∏',
                'health': '–ó–¥–æ—Ä–æ–≤—å–µ',
                'education': '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
                'bills': '–°—á–µ—Ç–∞',
                'utilities': '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
                'rent': '–ê—Ä–µ–Ω–¥–∞',
                'insurance': '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ',
                'taxes': '–ù–∞–ª–æ–≥–∏',
                'gifts': '–ü–æ–¥–∞—Ä–∫–∏',
                'subscriptions': '–ü–æ–¥–ø–∏—Å–∫–∏',
                'sports': '–°–ø–æ—Ä—Ç',
                'travel': '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è',
                'cafe': '–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã',
                'salary': '–ó–∞—Ä–ø–ª–∞—Ç–∞',
                'business': '–ë–∏–∑–Ω–µ—Å',
                'investment': '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',
                'freelance': '–§—Ä–∏–ª–∞–Ω—Å',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return labels[category] || category;
        }

        function openAddTransactionModal() {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é';
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.add('show');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('show');
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t._id === id);
            if (!transaction) return;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é';
            document.getElementById('transactionId').value = transaction._id;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionAccount').value = transaction.accountId?._id || '';
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionDate').value = new Date(transaction.date).toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.add('show');
        }

        async function deleteTransaction(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) return;

            try {
                const result = await api.deleteTransaction(id);
                if (result.success) {
                    showSuccess('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
                    loadTransactions();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        // Handle form submission
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('transactionId').value;
            const data = {
                type: document.getElementById('transactionType').value,
                accountId: document.getElementById('transactionAccount').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value,
                date: document.getElementById('transactionDate').value
            };

            try {
                let result;
                if (id) {
                    result = await api.updateTransaction(id, data);
                } else {
                    result = await api.createTransaction(data);
                }

                if (result.success) {
                    showSuccess(id ? '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞');
                    closeTransactionModal();
                    loadTransactions();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        });

        // Filter functions
        function applyFilters() {
            const filters = {};
            
            const type = document.getElementById('filterType').value;
            if (type) filters.type = type;
            
            const accountId = document.getElementById('filterAccount').value;
            if (accountId) filters.accountId = accountId;
            
            const startDate = document.getElementById('filterStartDate').value;
            if (startDate) filters.startDate = startDate;
            
            const endDate = document.getElementById('filterEndDate').value;
            if (endDate) filters.endDate = endDate;

            loadTransactions(filters);
        }

        function resetFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadTransactions();
        }

        // Close modal on background click
        document.getElementById('transactionModal').addEventListener('click', (e) => {
            if (e.target.id === 'transactionModal') {
                closeTransactionModal();
            }
        });

        // Logout button handler
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            auth.logout();
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
